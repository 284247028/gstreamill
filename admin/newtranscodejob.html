
    <div class="container-fluid">
        <div class="row newlivejob">
            <div class="panel panel-primary">
                <div class="panel-heading newtranscodejob" data-i18n="newtranscodejob.Select media files"></div>
                <div class="panel-body">
                    <input type="file" id="files" name="files[]" multiple />
                    <output id="list"></output>
                </div>
            </div>
            <div id='new_transcode_job_holder'></div>
            <div id='transcode_job_holder' style="display: none;"></div>
            <div id='encoder_editor_holder' style="display: none;"></div>
            <button class='btn btn-primary' id='createjob'>Create Transcode Job</button>
        </div>
    </div>


    <script type="text/javascript">

    $ (document).ready (function () {
        /* load configure */
        $.get("/admin/getconf", function (data) {
            if (data.result == "success") {
                Document.GstreamillConf.conf = data.data;
            } else {
                alert ("get configure failure: " + data.reason);
                return;
            }

            var element = document.getElementById ('new_transcode_job_holder');
            var conf_editor = new JSONEditor (element, {
                schema: {
                    $ref: "schemas/newtranscodejob_" + Document.GstreamillConf.language[Document.GstreamillConf.conf.language] + ".schema"
                },
                ajax: true,
                disable_collapse: true,
                disable_edit_json: true,
                disable_properties: true,
                disable_array_add: false,
                disable_array_delete: false,
                disable_array_reorder: true,
                theme: 'bootstrap3',
                iconlib: 'bootstrap3'
            });
            var file_list = [];

            conf_editor.on ('ready', function () {
                var transcode_root = Document.GstreamillConf.conf['transcode-root'];
                $("#files").change (function (evt) {
                    var files = evt.target.files;
                    var output = [];

                    file_list = [];
                    for (var i = 0, file; file = files[i]; i++) {
                        output.push ('<li><strong>', escape (file.name), '</strong> (', file.type || 'n/a', ') - ',
                                     file.size, ' bytes, last modified: ',
                                     file.lastModifiedDate ? file.lastModifiedDate.toLocaleDateString() : 'n/a',
                                     '</li>');
                        file_list.push (file.name);
                    }
                    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
                });

                $("#createjob").click (function () {
                    var conf_value = conf_editor.getValue ();
                    var transcode_element = document.getElementById ('transcode_job_holder');
                    var transcode_editor = new JSONEditor (transcode_element, {
                        schema: {
                            $ref: 'schemas/transcode_mpegts_mpeg2_mp123.schema'
                        },
                        ajax: true,
                        hidden: true
                    });

                    transcode_editor.on ('ready', function() {

                        var encoder_element = document.getElementById('encoder_editor_holder');
                        var encoder_editor = new JSONEditor (encoder_element, {
                            schema: {
                                $ref: 'schemas/transcode_encoder_mp4.schema'
                            },
                            ajax: true,
                            hidden: true
                        });
        
                        encoder_editor.on ('ready', function () {
                            for (var n = 0, file; file = file_list[n]; n++) {
                                var transcode_value = transcode_editor.getValue ();
                                var time = new Date().getTime();
                                transcode_value.name = "trancode_" + time.toString ();
                                transcode_value["log-path"] = transcode_root + "/out/" + file + "/";
                                transcode_value.source.elements.filesrc.property.location = transcode_root + "/in/" + file;
    
                                var encoder_conf_value = conf_editor.getValue ();
                                for (var i = 0; i < encoder_conf_value.length; i++) {
                                    for (key in encoder_conf_value[i]) {
                                        var subkeys = key.split ('&');
                                        if (subkeys.length != 3) {
                                            var editor = encoder_editor.getEditor ("root." + key);
                                            if (!editor)
                                                continue;
                                            editor.setValue (encoder_conf_value[i][key]);
    
                                        } else {
                                            /*
                                              elements.videoscale.caps&(\\d+)\\*(\\d+)&video/x-raw,width=$1,height=$2
                                              "&" seperated parameters, means as follow
                                              "elements.videoscale.caps".replace(/(\d+)\*(\d+)/, "video/x-raw,width=$1,height=$2")
                                             */
                                             var re = new RegExp (subkeys[1], 'g');
                                             var value = encoder_conf_value[i][key].replace (re, subkeys[2]);
                                             var editor = encoder_editor.getEditor ("root." + subkeys[0]);
                                             editor.setValue (value);
                                        }
                                    }
                                    var encoder_value = encoder_editor.getValue ();
                                    encoder_value.elements.filesink.property.location = transcode_root + "/out/" + file + encoder_conf_value[i]['elements.filesink.property.location'];
                                    transcode_value.encoders[i] = encoder_value;
                                }
    
                                $.post ("/admin/start", JSON.stringify (transcode_value, null, 4), function (response) {
                                    if (response.result == "success") {
                                        alert ('start ' + name + ' ' + response.result);
                    
                                    } else {
                                        alert (response.result + "\n" + response.reason);
                                    }
                                });
                            }
                        });
                    });
                });
            });

            $.i18n.init({
                lng: Document.GstreamillConf.language[Document.GstreamillConf.conf.language]
            }, function(t) {
                $(".nav").i18n ();
                $(".newtranscodejob").i18n ();
            });

        });
    });

    </script>
